on:
  push:
    branches:
      - 'main'
  pull_request:

jobs:
  unit_test:
    runs-on: ubuntu-latest
    name: 🧪 unit test
    steps:
      - name: 🛎️ Checkout
        uses: actions/checkout@v4
      - name: ⏬ Install Zenroom
        run: |
          wget https://github.com/dyne/zenroom/releases/latest/download/zenroom -O zenroom
          chmod +x zenroom
          sudo cp zenroom /usr/local/bin
      - name: 🚨 Run test
        run: make unit-test
  api_test:
    runs-on: ubuntu-latest
    name: 🧪 VCI API Tests
    steps:
      - name: 🛎️ Checkout
        uses: actions/checkout@v3
      - name: 🏗️ build
        run: make &
      - name: 🚨 Run api test
        run: npx stepci run "tests/credential_issuer.yml"
  publish_docker_image:
    needs: api_test
    name: 🐳 publish docker image
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    uses: interfacerproject/workflows/.github/workflows/publish-ghcr.yml@main
    secrets: inherit
