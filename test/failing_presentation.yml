env:
  credential_configuration_id: UniversityDegree_LDP_VC
  auth_body: "%7B%22email%22%3A%22test%40email.com%22%2C%22password%22%3A%22password%22%7D%2C%22custom_code%22%3A%22test_credential%22%7D"
steps:
  - $ref: steps/qr_to_wk.yml
  - $ref: steps/par.yml
  - $ref: steps/auth_1.yml
  - $ref: steps/auth_2.yml
  - $ref: steps/credential_ldp_vc.yml
  - $ref: steps/ver_qr_ldp_vc.yml
  - $ref: steps/scan_qr.yml
  - name: send wrong vp to rp
    http:
      url: http://${{env.mz_host}}/openid4vp_response
      method: POST
      json:
        body:
          vp_token:
            test_presentation_ldp_vc:
            - "@context":
              - ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.@context.0 }}
              - ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.@context.1 }}
              holder: ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.holder }}
              id: ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.id }}
              proof:
                challenge: ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.proof.challenge }}
                created: ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.proof.created }}
                cryptosuite: ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.proof.cryptosuite }}
                domain: ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.proof.domain }}
                proofPurpose: ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.proof.proofPurpose }}
                proofValue: ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.proof.proofValue }}
                type: ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.proof.type }}
                verificationMethod: ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.proof.verificationMethod }}
              type:
              - ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.type.0 }}
              verifiableCredential:
              - "@context":
                - ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.verifiableCredential.0.@context.0 }}
                - ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.verifiableCredential.0.@context.1 }}
                credentialSubject:
                  degree: ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.verifiableCredential.0.credentialSubject.degree }}
                  family_name: ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.verifiableCredential.0.credentialSubject.family_name }}
                  given_name: ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.verifiableCredential.0.credentialSubject.given_name }}
                issuer: ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.verifiableCredential.0.issuer }}
                proof:
                  created: ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.verifiableCredential.0.proof.created }}
                  cryptosuite: ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.verifiableCredential.0.proof.cryptosuite }}
                  proofPurpose: ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.verifiableCredential.0.proof.proofPurpose }}
                  proofValue: ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.verifiableCredential.0.proof.proofValue }}
                  type: ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.verifiableCredential.0.proof.type }}
                  verificationMethod: ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.verifiableCredential.0.proof.verificationMethod }}
                type:
                - ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.verifiableCredential.0.type.0 }}
                - WrongType
                validUntil: ${{ captures.vps.0.matching_credential_sets.0.test_presentation_ldp_vc.0.signed.verifiableCredential.0.validUntil }}
        url: ${{captures.post_url}}
      check:
        status: 200
        jsonpath:
          $.result.status:
            - eq: "500"

  - name: verifier checks transaction id
    http:
      url: http://${{env.verifier_host}}/${{captures.transaction_id}}
      method: GET
      check:
        status: 200
        body: Cryptographic verification failed