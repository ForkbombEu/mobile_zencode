steps:
  - name: holder_qr_to_well-known
    http:
      url: http://${{env.mz_host}}/holder_qr_to_well-known
      method: POST
      body:
        file: ${{env.path_to_wallet}}/wallet/holder_request_authorizationCode.data.json
      captures:
        credential_parameters:
          jsonpath: $.credential_parameters
      check:
        status: 200
        jsonpath:
          $.credential_parameters:
            - isDefined: true
              isObject: true
          $.credential_requested:
            - isDefined: true
              isObject: true

  - name: Create new credential
    http:
      url: http://${{env.mz_host}}/holder_request_authorizationCode
      method: POST
      json:
        holder_claims:
          given_name: Pippo
          family_name: Peppe
          is_human: true
        credential_parameters:
          authorization_endpoint: ${{captures.credential_parameters.authorization_endpoint}}
          authorization_server_endpoint_par: ${{captures.credential_parameters.authorization_server_endpoint_par}}
          code_challenge_method: ${{captures.credential_parameters.code_challenge_method}}
          credential_endpoint: ${{captures.credential_parameters.credential_endpoint}}
          credential_issuer: ${{captures.credential_parameters.credential_issuer}}
          format: ${{captures.credential_parameters.format}}
          grant_type: ${{captures.credential_parameters.grant_type}}
          response_type: ${{captures.credential_parameters.response_type}}
          token_endpoint: ${{captures.credential_parameters.token_endpoint}}
          vct: ${{captures.credential_parameters.vct}}
      captures:
        credential:
          jsonpath: $.result.credential
      check:
        status: 200
        jsonpath:
          $.result.credential:
            - isDefined: true
          $.result.c_nonce:
            - isDefined: true
          $.result.c_nonce_expires_in:
            - eq: 600

  - name: produce vp and send to rp
    http:
      url: http://${{env.mz_host}}/produce_verifiable_presentation
      method: POST
      json:
        relying_party: http://localhost:3003
        t: ehUYkktwQVWy_v9MXeTaf9:APA91bG28isX0dJJEzW6K5qA8N67-V7bZjYhEXYsWNyL_7xiJsBVTuKgEalgK_ajlK_6u2hY3tFlq0e649F4lhb909VHVfHGKrWFVb0uBdY61RmnLcxhwkltm2yyxxdXje1qWCavb281
        m: f
        exp: 2012669299
        request_uri: https://apiroom.net/api/DIDroom/didroom_verification_request_mock2
        id: abCDe
        credential_array:
          - ${{captures.credential}}
      captures:
        message:
          jsonpath: $.result.server_response.result.message
      check:
        status: 200
        jsonpath:
          $.result.server_response.result.message:
            - isDefined: true
            - isString: true
          $.result.server_response.result.registrationToken:
            - eq: ehUYkktwQVWy_v9MXeTaf9:APA91bG28isX0dJJEzW6K5qA8N67-V7bZjYhEXYsWNyL_7xiJsBVTuKgEalgK_ajlK_6u2hY3tFlq0e649F4lhb909VHVfHGKrWFVb0uBdY61RmnLcxhwkltm2yyxxdXje1qWCavb281

  - name: verifier checks rp response
    http:
      url: http://${{env.verifier_host}}/verify
      method: POST
      json:
        message: ${{captures.message}}
        claims_url: https://apiroom.net/api/DIDroom/didroom_verification_request_mock2
      check:
        status: 200
        jsonpath:
          $.result:
            - eq: Signature_verification_successful